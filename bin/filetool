#!/usr/bin/env ruby
require_relative "../lib/filetool.rb"
require "optparse"

  def show_usage
    puts "Usage:"
    puts " filetool show <file>"
    puts " filetool stats <file>"
    puts " filetool add <file> \"text\""
    puts " filetool search <file> \"text\""
    puts " filetool replace <file> \"from\" \"to\""
    puts " filetool create <file>"
    puts " filetool delete <file>"
    puts " filetool rename <old> <new>"
    puts " filetool mkdir <dirname>"
    puts " filetool rmdir <dirname>"
    puts " filetool ls <dirname>"
    puts " filetool pwd"
    puts " filetool cd <path>"
    puts " filetool seqrename <prefix>"
    exit
  end

if __FILE__ == $0

  options = {}

  opt = OptionParser.new do |opts|
    opts.on("-i", "--ignore-case", "Ignore case") do
      options[:ignore_case] = true
    end

    opts.on("-c", "--count", "Count matched only") do
      options[:count] = true
    end
  end

  opt.parse!

  command = ARGV.shift

  if command.nil?
    show_usage
    exit 1
  end

  begin
    case command

    when "show"
      filename = ARGV.shift or abort("File is missing")
      puts Filetool.show(filename)

    when "stats"
      filename = ARGV.shift or abort("File is missing")
      result = Filetool.stats(filename)
      puts "Lines: #{result[:lines]}"
      puts "Words: #{result[:words]}"
      puts "Chars: #{result[:chars]}"

    when "add"
      filename = ARGV.shift or abort("File is missing")
      text = ARGV.shift or abort("Text to add is missing")
      Filetool.add(filename, text)
      puts "Added text to #{filename}"

    when "search"
      filename = ARGV.shift or abort("File is missing")
      text = ARGV.shift or abort("String to search is missing")
      puts Filetool.search(filename, text, options)

    when "replace"
      filename = ARGV.shift or abort("File is missing")
      from = ARGV.shift or abort("String to replace is missing")
      to = ARGV.shift or abort("Replacement string is missing")
      puts Filetool.replace!(filename, from, to)

    when "create"
      filename = ARGV.shift or abort("File is missing")
      Filetool.create(filename)
      puts "Created #{filename}"

    when "delete"
      filename = ARGV.shift or abort("File is missing")
      Filetool.delete(filename)
      puts "Deleted #{filename}"

    when "rename"
      old = ARGV.shift or abort("Old filename is missing")
      new_name = ARGV.shift or abort("New filename in missing")
      Filetool.rename(old, new_name)
      puts "Renamed #{old} to #{new_name}"

    when "mkdir"
      dirname = ARGV.shift or abort("Directory name is missing")
      Filetool.mkdir(dirname)
      puts "Directory created"

    when "rmdir"
      dirname = ARGV.shift or abort("Directory name is missing")
      Filetool.rmdir(dirname)
      puts "Directory deleted"

    when "ls"
      dirname = ARGV.shift || "."
      puts Filetool.ls(dirname)

    when "pwd"
      puts Filetool.pwd

    when "cd"
      path = ARGV.shift or abort("Path is missing")
      puts Filetool.cd(path)

    when "seqrename"
      prefix = ARGV.shift or abort("File is missing")
      Filetool.seqrename(prefix)
      puts "File renamed"

    else
      puts "Unknown command: #{command}"
      exit 1
    end
  rescue Errno::ENOENT => e
    puts "File not found: #{e.message}"
    exit 1
  rescue Errno::EACCES => e
    puts "Permission denied: #{e.message}"
    exit 1
  rescue => e
    puts "Unexpected error: #{e.message}"
    exit 1
  end
end
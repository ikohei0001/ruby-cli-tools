#!/usr/bin/env ruby
require_relative "../lib/filetool.rb"
require "optparse"

if __FILE__ == $0

  options = {}

  opt = OptionParser.new do |opts|
    opts.on("-i", "--ignore-case", "Ignore case") do
      options[:ignore_case] = true
    end

    opts.on("-c", "--count", "Count matched only") do
      options[:count] = true
    end
  end

  opt.parse!
  
  command = ARGV.shift
  filename = ARGV.shift
  arg1 = ARGV.shift
  arg2 = ARGV.shift

  if command.nil? || filename.nil?
    puts "Usage:"
    puts " filetool show <file>"
    puts " filetool stats <file>"
    puts " filetool add <file> \"text\""
    puts " filetool search <file> \"text\""
    puts " filetool replace <file> \"from\" \"to\""
    puts " filetool create <file>"
    puts " filetool delete <file>"
    puts " filetool rename <old> <new>"
    puts " filetool mkdir <dirname>"
    puts " filetool rmdir <dirname>"
    exit
  end

  begin
    case command
    when "show"
      puts Filetool.show(filename)

    when "stats"
      result = Filetool.stats(filename)
      puts "Lines: #{result[:lines]}"
      puts "Words: #{result[:words]}"
      puts "Chars: #{result[:chars]}"

    when "add"
      if arg1.nil?
        puts "Text to add is missing"
        exit 1
      end
      Filetool.add(filename, arg1)
      puts "Added text to #{filename}"

    when "search"
      if arg1.nil?
        puts "string to search is missing"
        exit 1
      end
      puts Filetool.search(filename, arg1, options)

    when "replace"
      if arg1.nil? || arg2.nil?
        puts "string to replace is missing"
        exit 1
      end
      puts Filetool.replace!(filename, arg1, arg2)

    when "create"
      Filetool.create(filename)
      puts "Created #{filename}"

    when "delete"
      Filetool.delete(filename)
      puts "Deleted #{filename}"

    when "rename"
      Filetool.rename(filename, arg1)
      puts "Renamed #{filename} to #{arg1}"

    when "mkdir"
      Filetool.mkdir(arg0)
      puts "Directory created"

    when "rmdir"
      Filetool.rmdir(arg0)
      puts "Directory deleted"

    when "ls"
      puts Filetool.ls(arg0)

    else
      puts "Unknown command: #{command}"
    end
  rescue Errno::ENOENT
    puts "File not found: #{filename}"
    exit 1
  rescue Errno::EACCES
    puts "Permission denied: #{filename}"
    exit 1
  rescue => e
    puts "Unexpected error: #{e.message}"
    exit 1
  end
end